<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>JetLagPal</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        .crosshair-cursor { cursor: crosshair !important; }
        
        #controls {
            position: absolute; top: 10px; right: 10px; background: white;
            padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000; width: 340px; max-width: 90vw; max-height: 90vh; overflow-y: auto;
            display: flex; flex-direction: column; transition: all 0.2s ease;
        }

        .controls-header { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid #0078A8; padding-bottom: 8px; margin-bottom: 10px;
        }
        h3 { margin: 0; font-size: 1.1em; color: #333; }
        
        .header-btns { display: flex; gap: 5px; }
        
        .icon-btn-header { 
            width: 32px; height: 32px; padding: 0; margin: 0; 
            background: #f0f0f0; color: #333; font-size: 1.2em; font-weight: bold;
            border: 1px solid #ccc; border-radius: 4px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .gps-btn { color: #0078A8; font-size: 1.4em; }
        .help-btn { color: #28a745; font-weight: bold; font-family: serif; }

        #controls.minimized {
            width: auto; min-width: 140px; height: auto; max-height: 60px; overflow: hidden;
        }
        #controls.minimized .tab-bar, 
        #controls.minimized .tab-content { display: none !important; }
        #controls.minimized .controls-header { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }

        .tab-bar { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px 5px; border: none; background: #f9f9f9; cursor: pointer; font-weight: bold; color: #666; font-size: 0.85em; }
        .tab-btn.active { background: #fff; border-bottom: 2px solid #0078A8; color: #0078A8; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .tool-section { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        label { display: block; margin-top: 8px; font-size: 0.9em; font-weight: bold;}
        input[type="number"], input[type="text"], select { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;}
        
        button { width: 100%; padding: 10px; margin-top: 10px; background-color: #0078A8; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        .active-tool-btn { background-color: #d9534f !important; border-color: #d43f3a !important; }

        /* Layer List Controls */
        .toggle-btn { flex: 1; padding: 6px; font-size: 0.8em; border: 1px solid #ccc; background: white; cursor: pointer; }
        .toggle-btn.is-hit { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .toggle-btn.is-miss { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }
        
        #layerList { list-style: none; padding: 0; margin: 0; }
        .layer-item { padding: 10px; border-bottom: 1px solid #eee; background: #fafafa; margin-bottom: 5px; border-radius: 4px; }
        .layer-header { display: flex; align-items: center; margin-bottom: 8px; }
        
        .layer-name { font-weight: bold; color: #333; font-size: 0.95em; cursor: pointer; border-bottom: 1px dashed #ccc; flex-grow: 1; margin-right: 10px; }
        .icon-group { display: flex; gap: 8px; }
        .icon-btn { background: none; border: none; color: #888; font-size: 1.1em; width: auto; padding: 0; margin: 0; cursor: pointer; }
        .del-btn:hover { color: #d9534f; }
        .layer-controls { display: flex; gap: 5px; }
        .input-group { display: flex; gap: 5px; margin-top: 5px; }
        .input-group button { margin-top: 0; width: auto; padding: 8px 15px; }
        
        #loader { display: none; text-align: center; margin-top: 10px; color: #0078A8; }
        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; font-size: 0.85em; }
        .legend-item { display: flex; align-items: center; }
        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .line-box { width: 15px; height: 4px; margin-right: 5px; }

        /* Log Book Styles */
        .log-list-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .log-index { font-weight: bold; color: #0078A8; margin-right: 10px; min-width: 20px; }
        .log-meta { font-size: 0.85em; color: #888; margin-left: 5px; font-style: italic; }

        /* Question Styles */
        .q-category { margin-bottom: 20px; }
        .q-cat-title { font-size: 1.1em; font-weight: bold; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; display:flex; justify-content: space-between; cursor: pointer; user-select: none;}
        .q-subcat { margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.95em; }
        .q-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .q-btn { padding: 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 0.9em; text-align: center; color: #333; user-select: none; transition: background 0.2s; }
        .q-btn:hover { background: #e0e0e0; }
        .q-btn.asked { background-color: #d9534f; color: white; border-color: #d43f3a; }
        .q-content { display: none; }
        .q-content.open { display: block; }
        .arrow { font-size: 0.8em; color: #999; }
        
        /* Popup Link Styles */
        .popup-link { display: inline-block; margin-top: 5px; color: white; background: #0078A8; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; border:none; }
        .popup-link:hover { background: #005a7d; }

        /* MODAL STYLES (Mobile Responsive) */
        #webModal, #tutorialModal {
            display: none; 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 9999;
        }
        #modalContent, #tutorialContent {
            background: white; width: 90%; max-width: 500px; max-height: 90%; margin: 5% auto;
            display: flex; flex-direction: column; border-radius: 8px; overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #modalHeader, #tutorialHeader {
            padding: 10px; background: #eee; border-bottom: 1px solid #ccc;
            display: flex; justify-content: space-between; align-items: center;
        }
        #modalTitle, #tutorialTitle { font-weight: bold; font-size: 1.1em; color:#333; }
        #modalFrame { flex: 1; border: none; background: #fff; }
        #modalFallback { padding: 8px; text-align: center; font-size: 0.8em; background: #f8d7da; display:none; color: #721c24; }
        
        /* Tutorial Specifics */
        #tutorialBody { padding: 20px; overflow-y: auto; font-size: 0.95em; line-height: 1.5; color: #333; }
        .tut-step { margin-bottom: 15px; display: flex; gap: 10px; }
        .tut-icon { font-weight: bold; color: #0078A8; min-width: 25px; }
        #closeTutBtn { width: 100%; background: #28a745; margin-top: 10px; padding: 12px; font-size: 1em; }
        
        #closeModalBtn { background: #d9534f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; width: auto; margin:0;}
        #extLinkBtn { background: #0078A8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; text-decoration:none; font-size:0.8em; margin-right:5px;}
    </style>
</head>
<body>

    <div id="webModal">
        <div id="modalContent">
            <div id="modalHeader">
                <span id="modalTitle">Station Info</span>
                <div>
                    <a id="extLinkBtn" href="#" target="_blank">Open Browser</a>
                    <button id="closeModalBtn" onclick="closeModal()">Close</button>
                </div>
            </div>
            <div id="modalFallback">If the page is blank, security settings blocked it. Click "Open Browser".</div>
            <iframe id="modalFrame" src=""></iframe>
        </div>
    </div>

    <div id="tutorialModal">
        <div id="tutorialContent">
            <div id="tutorialHeader">
                <span id="tutorialTitle">Welcome to JetLagPal!</span>
            </div>
            <div id="tutorialBody">
                <div class="tut-step">
                    <div class="tut-icon">1.</div>
                    <div><strong>Load Data First:</strong> Click the "Load Stations" button in the Tools tab to load the Station Data.</div>
                </div>
                <div class="tut-step">
                    <div class="tut-icon">2.</div>
                    <div><strong>Use the Tools:</strong> Choose from Radar, Line split, Borough Match or Zone Match to mark where the hider can and can't be!</div>
                </div>
                <div class="tut-step">
                    <div class="tut-icon">3.</div>
                    <div><strong>Track Questions:</strong> Go to the Questions tab to log the questions you have asked, and visit the Log to see the order & cards the Hider has.</div>
                </div>
                <div class="tut-step">
                    <div class="tut-icon">4.</div>
                    <div><strong>Live Info:</strong> Tap any station dot on the map to be taken to the live departures for that stop (opens new tabs).</div>
                </div>              
                <div class="tut-step">
                    <div class="tut-icon">5.</div>
                    <div><strong>Menu:</strong> Use <span style="font-weight:bold; color:#0078A8;">◎</span> to find your current GPS location and <span style="font-weight:bold;">−</span> to hide this menu. Use the <span style="font-weight:bold;">?</span> to revisit this information. </div>
                </div>
                <button id="closeTutBtn" onclick="closeTutorial()">Got it! Let's Go.</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="controls-header">
            <h3>JetLagPal</h3>
            <div class="header-btns">
                <button class="icon-btn-header help-btn" onclick="openTutorial()" title="Help">?</button>
                <button class="icon-btn-header gps-btn" onclick="locateMe()" title="Locate Me">◎</button>
                <button class="icon-btn-header" id="minBtn" onclick="toggleControls()">−</button>
            </div>
        </div>

        <div class="tab-bar">
            <button id="btn-tab-tools" class="tab-btn active" onclick="switchTab('tools')">Tools</button>
            <button id="btn-tab-layers" class="tab-btn" onclick="switchTab('layers')">Layers</button>
            <button id="btn-tab-questions" class="tab-btn" onclick="switchTab('questions')">Questions</button>
            <button id="btn-tab-log" class="tab-btn" onclick="switchTab('log')">Log</button>
        </div>

        <div id="tab-tools" class="tab-content active">
            <button onclick="undoLast()" style="background:#f0ad4e;">⎌ Undo Last</button>

            <div class="tool-section">
                <strong>Data Layer</strong>
                <button id="btnLoadTransport" onclick="loadTransportData()">Load Stations</button>
                <div id="loader">Fetching...</div>
                <div id="legend" style="display:none;">
                    <div class="legend-grid">
                        <div class="legend-item"><span class="dot" style="background:#FFC107; border:1px solid #888;"></span> Stop</div>
                        <div class="legend-item"><span class="dot" style="background:#333;"></span> Station</div>
                        <div class="legend-item"><span class="line-box" style="background:purple;"></span> Tram</div>
                        <div class="legend-item"><span class="line-box" style="background:#444; border-bottom:1px dashed white;"></span> Rail</div>
                    </div>
                    <button onclick="toggleTransport()" style="background:#666; font-size: 0.8em; padding: 5px; margin-top:10px;">Toggle Visibility</button>
                    <button onclick="forceRefreshData()" style="background:#999; font-size: 0.8em; padding: 5px; margin-top:5px;">↻ Force Re-download</button>
                </div>
            </div>

            <div class="tool-section">
                <strong>1. Radar</strong>
                <label>Radius (km):</label>
                <input type="number" id="radiusInput" value="5" min="0.1" step="0.1">
                <div class="input-group">
                    <input type="text" id="radiusCoords" placeholder="53.48, -2.24">
                    <button onclick="manualRadius()" style="background:#4CAF50;">Go</button>
                </div>
                <button id="btnRadius" onclick="startRadiusTool(event)">Pick Center</button>
                <button id="btnGpsRadius" onclick="radiusAtGPS()" style="background:#0078A8; margin-top:5px;">Use My Location</button>
            </div>

            <div class="tool-section">
                <strong>2. Line split</strong>
                <div class="input-group">
                    <input type="text" id="angleCoords" placeholder="53.48, -2.24">
                    <button onclick="manualAngle()" style="background:#4CAF50;">Go</button>
                </div>
                <button id="btnAngle" onclick="startAngleTool(event)">Draw & Rotate</button>
            </div>

            <div class="tool-section">
                <strong>3. Borough Match</strong>
                <label>Select Borough:</label>
                <select id="boroughSelect">
                    <option value="Bolton">Bolton</option>
                    <option value="Bury">Bury</option>
                    <option value="Manchester">Manchester</option>
                    <option value="Oldham">Oldham</option>
                    <option value="Rochdale">Rochdale</option>
                    <option value="Salford">Salford</option>
                    <option value="Stockport">Stockport</option>
                    <option value="Tameside">Tameside</option>
                    <option value="Trafford">Trafford</option>
                    <option value="Wigan">Wigan</option>
                </select>
                <button onclick="addBorough()" style="background:#4CAF50;">Add Layer</button>
            </div>

            <div class="tool-section">
                <strong>4. Zone Match</strong>
                <label>Select Zone:</label>
                <select id="zoneSelect">
                    <option value="1">Zone 1 (City)</option>
                    <option value="2">Zone 2</option>
                    <option value="3">Zone 3</option>
                    <option value="4">Zone 4 (Outer)</option>
                </select>
                <button onclick="addZoneLayer()" style="background:#4CAF50;">Add Zone Layer</button>
            </div>
            
             <button onclick="clearAll()" style="background:#d9534f; margin-top:20px;">Clear All</button>
        </div>

        <div id="tab-layers" class="tab-content">
            <div style="font-size:0.85em; color:#555; margin-bottom:10px; background:#eef; padding:8px; border-radius:4px;">
                <strong>Map Colours:</strong><br>GREEN = Potential Locations<br>RED = No longer Possible
            </div>
            <ul id="layerList"></ul>
             <button onclick="clearAll()" style="background:#d9534f; margin-top:20px;">Clear All</button>
        </div>

        <div id="tab-questions" class="tab-content">
            <div id="questionsContainer"></div>
            <button onclick="resetQuestions()" style="background:#999; font-size:0.9em; margin-top:20px;">Reset All Questions</button>
        </div>

        <div id="tab-log" class="tab-content">
            <div style="font-size:0.85em; color:#555; padding:5px; background:#eef; margin-bottom:10px;">
                <strong>Question Log:</strong><br>
            </div>
            <div id="logList"></div>
            <button onclick="clearLog()" style="background:#d9534f; margin-top:20px;">Reset Log</button>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <script>
        // --- 1. Map Setup ---
        var map = L.map('map').setView([53.4808, -2.2426], 11); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19
        }).addTo(map);

        map.createPane('stations');
        map.getPane('stations').style.zIndex = 650;

        var transportLayer = L.layerGroup().addTo(map); 
        var logicLayer = L.layerGroup().addTo(map);     
        var guideLayer = L.layerGroup().addTo(map);     
        var gpsLayer = L.layerGroup().addTo(map);

        var myConstraints = []; 
        var worldBbox = [-15.0, 48.0, 5.0, 62.0]; 
        var worldPoly = turf.bboxPolygon(worldBbox);

        var controlsDiv = document.getElementById('controls');
        L.DomEvent.disableClickPropagation(controlsDiv);
        L.DomEvent.disableScrollPropagation(controlsDiv);

        // --- 2. Station Data Logic (UPDATED) ---
        async function loadTransportData() {
            var loader = document.getElementById('loader');
            loader.style.display = 'block';

            // 1. Broad Bounding Box for Greater Manchester
            var bbox = "53.330,-2.720,53.690,-1.910";

            // 2. Query for stations, halts, and tram stops
            var query = `
                [out:json][timeout:25];
                (
                  node["railway"~"station|halt"](${bbox});
                  node["tram"~"stop"](${bbox});
                );
                out body;
            `;

            var url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(query);

            try {
                var response = await fetch(url);
                var data = await response.json();

                // Clear old data before drawing new
                transportLayer.clearLayers();

                // 3. Draw the data from the API
                data.elements.forEach(element => {
                    var lat = element.lat;
                    var lon = element.lon;
                    var name = element.tags.name || "Unknown Stop";
                    
                    // Style: Stations are black/large, Trams are small/yellow
                    // NOTE: This logic might miss Hall-i'-th'-Wood if API excludes it, 
                    // which is why we add it manually below.
                    var isStation = (element.tags.railway === 'station' || element.tags.railway === 'halt');
                    
                    var marker = L.circleMarker([lat, lon], {
                        radius: isStation ? 6 : 4,
                        fillColor: isStation ? "#333" : "#FFC107",
                        color: "#000",
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8,
  
