<!DOCTYPE html>

<html>

<head>

    <meta charset="utf-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>JetLagPal</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>

        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }

        #map { height: 100vh; width: 100%; z-index: 1; }

       

        .crosshair-cursor { cursor: crosshair !important; }

       

        #controls {

            position: absolute; top: 10px; right: 10px; background: white;

            padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);

            z-index: 1000; width: 340px; max-width: 90vw; max-height: 90vh; overflow-y: auto;

            display: flex; flex-direction: column; transition: all 0.2s ease;

        }



        .controls-header {

            display: flex; justify-content: space-between; align-items: center;

            border-bottom: 2px solid #0078A8; padding-bottom: 8px; margin-bottom: 10px;

        }

        h3 { margin: 0; font-size: 1.1em; color: #333; }

       

        .header-btns { display: flex; gap: 5px; }

       

        .icon-btn-header {

            width: 32px; height: 32px; padding: 0; margin: 0;

            background: #f0f0f0; color: #333; font-size: 1.2em; font-weight: bold;

            border: 1px solid #ccc; border-radius: 4px; cursor: pointer;

            display: flex; align-items: center; justify-content: center;

        }

        .gps-btn { color: #0078A8; font-size: 1.4em; }

        .help-btn { color: #28a745; font-weight: bold; font-family: serif; }



        #controls.minimized {

            width: auto; min-width: 140px; height: auto; max-height: 60px; overflow: hidden;

        }

        #controls.minimized .tab-bar,

        #controls.minimized .tab-content { display: none !important; }

        #controls.minimized .controls-header { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }



        .tab-bar { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; }

        .tab-btn { flex: 1; padding: 10px 5px; border: none; background: #f9f9f9; cursor: pointer; font-weight: bold; color: #666; font-size: 0.85em; }

        .tab-btn.active { background: #fff; border-bottom: 2px solid #0078A8; color: #0078A8; }

        .tab-content { display: none; }

        .tab-content.active { display: block; }



        .tool-section { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }

        label { display: block; margin-top: 8px; font-size: 0.9em; font-weight: bold;}

        input[type="number"], input[type="text"], select { width: 100%; padding: 8px; margin-top: 4px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px;}

       

        button { width: 100%; padding: 10px; margin-top: 10px; background-color: #0078A8; color: white; border: none; border-radius: 4px; cursor: pointer; transition: background 0.2s; }

        button:hover { opacity: 0.9; }

        button:disabled { background-color: #ccc; cursor: not-allowed; }

        .active-tool-btn { background-color: #d9534f !important; border-color: #d43f3a !important; }



        /* Layer List Controls */

        .toggle-btn { flex: 1; padding: 6px; font-size: 0.8em; border: 1px solid #ccc; background: white; cursor: pointer; }

        .toggle-btn.is-hit { background: #d4edda; color: #155724; border-color: #c3e6cb; }

        .toggle-btn.is-miss { background: #f8d7da; color: #721c24; border-color: #f5c6cb; }

       

        #layerList { list-style: none; padding: 0; margin: 0; }

        .layer-item { padding: 10px; border-bottom: 1px solid #eee; background: #fafafa; margin-bottom: 5px; border-radius: 4px; }

        .layer-header { display: flex; align-items: center; margin-bottom: 8px; }

       

        .layer-name { font-weight: bold; color: #333; font-size: 0.95em; cursor: pointer; border-bottom: 1px dashed #ccc; flex-grow: 1; margin-right: 10px; }

        .icon-group { display: flex; gap: 8px; }

        .icon-btn { background: none; border: none; color: #888; font-size: 1.1em; width: auto; padding: 0; margin: 0; cursor: pointer; }

        .del-btn:hover { color: #d9534f; }

        .layer-controls { display: flex; gap: 5px; }

        .input-group { display: flex; gap: 5px; margin-top: 5px; }

        .input-group button { margin-top: 0; width: auto; padding: 8px 15px; }

       

        #loader { display: none; text-align: center; margin-top: 10px; color: #0078A8; }

        .legend-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; font-size: 0.85em; }

        .legend-item { display: flex; align-items: center; }

        .dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }

        .line-box { width: 15px; height: 4px; margin-right: 5px; }



        /* Log Book Styles */

        .log-list-item { padding: 10px; border-bottom: 1px solid #eee; font-size: 0.9em; color: #333; display: flex; justify-content: space-between; align-items: center; }

        .log-index { font-weight: bold; color: #0078A8; margin-right: 10px; min-width: 20px; }

        .log-meta { font-size: 0.85em; color: #888; margin-left: 5px; font-style: italic; }



        /* Question Styles */

        .q-category { margin-bottom: 20px; }

        .q-cat-title { font-size: 1.1em; font-weight: bold; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px; margin-bottom: 10px; display:flex; justify-content: space-between; cursor: pointer; user-select: none;}

        .q-subcat { margin-top: 10px; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.95em; }

        .q-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

        .q-btn { padding: 10px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 0.9em; text-align: center; color: #333; user-select: none; transition: background 0.2s; }

        .q-btn:hover { background: #e0e0e0; }

        .q-btn.asked { background-color: #d9534f; color: white; border-color: #d43f3a; }

        .q-content { display: none; }

        .q-content.open { display: block; }

        .arrow { font-size: 0.8em; color: #999; }

       

        /* Popup Link Styles */

        .popup-link { display: inline-block; margin-top: 5px; color: white; background: #0078A8; padding: 6px 12px; text-decoration: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; border:none; }

        .popup-link:hover { background: #005a7d; }



        /* MODAL STYLES (Mobile Responsive) */

        #webModal, #tutorialModal {

            display: none;

            position: fixed; top: 0; left: 0; width: 100%; height: 100%;

            background: rgba(0,0,0,0.6); z-index: 9999;

        }

        #modalContent, #tutorialContent {

            background: white; width: 90%; max-width: 500px; max-height: 90%; margin: 5% auto;

            display: flex; flex-direction: column; border-radius: 8px; overflow: hidden;

            box-shadow: 0 5px 15px rgba(0,0,0,0.5);

        }

        #modalHeader, #tutorialHeader {

            padding: 10px; background: #eee; border-bottom: 1px solid #ccc;

            display: flex; justify-content: space-between; align-items: center;

        }

        #modalTitle, #tutorialTitle { font-weight: bold; font-size: 1.1em; color:#333; }

        #modalFrame { flex: 1; border: none; background: #fff; }

        #modalFallback { padding: 8px; text-align: center; font-size: 0.8em; background: #f8d7da; display:none; color: #721c24; }

       

        /* Tutorial Specifics */

        #tutorialBody { padding: 20px; overflow-y: auto; font-size: 0.95em; line-height: 1.5; color: #333; }

        .tut-step { margin-bottom: 15px; display: flex; gap: 10px; }

        .tut-icon { font-weight: bold; color: #0078A8; min-width: 25px; }

        #closeTutBtn { width: 100%; background: #28a745; margin-top: 10px; padding: 12px; font-size: 1em; }

       

        #closeModalBtn { background: #d9534f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; width: auto; margin:0;}

        #extLinkBtn { background: #0078A8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; text-decoration:none; font-size:0.8em; margin-right:5px;}

    </style>

</head>

<body>



    <div id="webModal">

        <div id="modalContent">

            <div id="modalHeader">

                <span id="modalTitle">Station Info</span>

                <div>

                    <a id="extLinkBtn" href="#" target="_blank">Open Browser</a>

                    <button id="closeModalBtn" onclick="closeModal()">Close</button>

                </div>

            </div>

            <div id="modalFallback">If the page is blank, security settings blocked it. Click "Open Browser".</div>

            <iframe id="modalFrame" src=""></iframe>

        </div>

    </div>



    <div id="tutorialModal">

        <div id="tutorialContent">

            <div id="tutorialHeader">

                <span id="tutorialTitle">Welcome to JetLagPal!</span>

            </div>

            <div id="tutorialBody">

                <div class="tut-step">

                    <div class="tut-icon">1.</div>

                    <div><strong>Load Data First:</strong> Click the "Load Stations" button in the Tools tab to load the Station Datak.</div>

                </div>

                <div class="tut-step">

                    <div class="tut-icon">2.</div>

                    <div><strong>Use the Tools:</strong> Choose from Radius, Lines, Boroughs or zones to mark where the hider can and can't be!</div>

                </div>

                <div class="tut-step">

                    <div class="tut-icon">3.</div>

                    <div><strong>Track Questions:</strong> Go to the Questions tab to log the questions you have asked, and visit the Log to see the order & cards the Hider has.</div>

                </div>

                <div class="tut-step">

                    <div class="tut-icon">4.</div>

                    <div><strong>Live Info:</strong> Tap any station dot on the map to be taken to the live departures for that stop (opens new tabs).</div>

                </div>              

                <div class="tut-step">

                    <div class="tut-icon">5.</div>

                    <div><strong>Menu:</strong> Use <span style="font-weight:bold; color:#0078A8;">◎</span> to find your current GPS location and <span style="font-weight:bold;">−</span> to hide this menu. Use the <span style="font-weight:bold;">?</span> to revisit this information. </div>

                </div>

                <button id="closeTutBtn" onclick="closeTutorial()">Got it! Let's Go.</button>

            </div>

        </div>

    </div>



    <div id="controls">

        <div class="controls-header">

            <h3>JetLagPal</h3>

            <div class="header-btns">

                <button class="icon-btn-header help-btn" onclick="openTutorial()" title="Help">?</button>

                <button class="icon-btn-header gps-btn" onclick="locateMe()" title="Locate Me">◎</button>

                <button class="icon-btn-header" id="minBtn" onclick="toggleControls()">−</button>

            </div>

        </div>



        <div class="tab-bar">

            <button class="tab-btn active" onclick="switchTab('tools')">Tools</button>

            <button class="tab-btn" onclick="switchTab('layers')">Layers</button>

            <button class="tab-btn" onclick="switchTab('questions')">Questions</button>

            <button class="tab-btn" onclick="switchTab('log')">Log</button>

        </div>



        <div id="tab-tools" class="tab-content active">

            <button onclick="undoLast()" style="background:#f0ad4e;">⎌ Undo Last</button>



            <div class="tool-section">

                <strong>Data Layer</strong>

                <button id="btnLoadTransport" onclick="loadTransportData()">Load Stations</button>

                <div id="loader">Fetching...</div>

                <div id="legend" style="display:none;">

                    <div class="legend-grid">

                        <div class="legend-item"><span class="dot" style="background:#FFC107; border:1px solid #888;"></span> Stop</div>

                        <div class="legend-item"><span class="dot" style="background:#333;"></span> Station</div>

                        <div class="legend-item"><span class="line-box" style="background:purple;"></span> Tram</div>

                        <div class="legend-item"><span class="line-box" style="background:#444; border-bottom:1px dashed white;"></span> Rail</div>

                    </div>

                    <button onclick="toggleTransport()" style="background:#666; font-size: 0.8em; padding: 5px; margin-top:10px;">Toggle Visibility</button>

                    <button onclick="forceRefreshData()" style="background:#999; font-size: 0.8em; padding: 5px; margin-top:5px;">↻ Force Re-download</button>

                </div>

            </div>



            <div class="tool-section">

                <strong>1. Radar</strong>

                <label>Radius (km):</label>

                <input type="number" id="radiusInput" value="5" min="0.1" step="0.1">

                <div class="input-group">

                    <input type="text" id="radiusCoords" placeholder="53.48, -2.24">

                    <button onclick="manualRadius()" style="background:#4CAF50;">Go</button>

                </div>

                <button id="btnRadius" onclick="startRadiusTool(event)">Pick Center</button>

                <button id="btnGpsRadius" onclick="radiusAtGPS()" style="background:#0078A8; margin-top:5px;">Use My Location</button>

            </div>



            <div class="tool-section">

                <strong>2. Line split</strong>

                <div class="input-group">

                    <input type="text" id="angleCoords" placeholder="53.48, -2.24">

                    <button onclick="manualAngle()" style="background:#4CAF50;">Go</button>

                </div>

                <button id="btnAngle" onclick="startAngleTool(event)">Draw & Rotate</button>

            </div>



            <div class="tool-section">

                <strong>3. Borough Match</strong>

                <label>Select Borough:</label>

                <select id="boroughSelect">

                    <option value="Bolton">Bolton</option>

                    <option value="Bury">Bury</option>

                    <option value="Manchester">Manchester</option>

                    <option value="Oldham">Oldham</option>

                    <option value="Rochdale">Rochdale</option>

                    <option value="Salford">Salford</option>

                    <option value="Stockport">Stockport</option>

                    <option value="Tameside">Tameside</option>

                    <option value="Trafford">Trafford</option>

                    <option value="Wigan">Wigan</option>

                </select>

                <button onclick="addBorough()" style="background:#4CAF50;">Add Layer</button>

            </div>



            <div class="tool-section">

                <strong>4. Zone Match</strong>

                <label>Select Zone:</label>

                <select id="zoneSelect">

                    <option value="1">Zone 1 (City)</option>

                    <option value="2">Zone 2</option>

                    <option value="3">Zone 3</option>

                    <option value="4">Zone 4 (Outer)</option>

                </select>

                <button onclick="addZoneLayer()" style="background:#4CAF50;">Add Zone Layer</button>

            </div>

           

             <button onclick="clearAll()" style="background:#d9534f; margin-top:20px;">Clear All</button>

        </div>



        <div id="tab-layers" class="tab-content">

            <div style="font-size:0.85em; color:#555; margin-bottom:10px; background:#eef; padding:8px; border-radius:4px;">

                <strong>Map Colours:</strong><br>GREEN = Potential Locations<br>RED = No longer Possible

            </div>

            <ul id="layerList"></ul>

             <button onclick="clearAll()" style="background:#d9534f; margin-top:20px;">Clear All</button>

        </div>



        <div id="tab-questions" class="tab-content">

            <div id="questionsContainer"></div>

            <button onclick="resetQuestions()" style="background:#999; font-size:0.9em; margin-top:20px;">Reset All Questions</button>

        </div>



        <div id="tab-log" class="tab-content">

            <div style="font-size:0.85em; color:#555; padding:5px; background:#eef; margin-bottom:10px;">

                <strong>Question Log:</strong><br>

            </div>

            <div id="logList"></div>

            <button onclick="clearLog()" style="background:#d9534f; margin-top:20px;">Reset Log</button>

        </div>

    </div>



    <div id="map"></div>



    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>



    <script>

        // --- 1. Map Setup ---

        var map = L.map('map').setView([53.4808, -2.2426], 11);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {

            attribution: '&copy; CARTO', subdomains: 'abcd', maxZoom: 19

        }).addTo(map);



        var transportLayer = L.layerGroup().addTo(map);

        var logicLayer = L.layerGroup().addTo(map);    

        var guideLayer = L.layerGroup().addTo(map);    

        var gpsLayer = L.layerGroup().addTo(map);



        var stationMap = {};

        var myConstraints = [];

        var worldBbox = [-15.0, 48.0, 5.0, 62.0];

        var worldPoly = turf.bboxPolygon(worldBbox);



        var controlsDiv = document.getElementById('controls');

        L.DomEvent.disableClickPropagation(controlsDiv);

        L.DomEvent.disableScrollPropagation(controlsDiv);



        function fixGeometry(geo) { try { return turf.buffer(geo, 0); } catch(e) { return geo; } }



        function updateLogicMap() {

            try {

                logicLayer.clearLayers();

                if (myConstraints.length === 0) return;

                var allowedZone = worldPoly;

                for (let c of myConstraints) {

                    var constraintGreenShape = null;

                    if (c.type === 'radius' || c.type === 'borough' || c.type === 'zone') {

                        if (c.state === 'hit') constraintGreenShape = c.geometry;

                        else constraintGreenShape = turf.difference(worldPoly, c.geometry);

                    }

                    else if (c.type === 'angle') {

                        if (c.state === 'hit') constraintGreenShape = c.geometry;

                        else constraintGreenShape = turf.difference(worldPoly, c.geometry);

                    }

                    if (constraintGreenShape) {

                        var cleanShape = fixGeometry(constraintGreenShape);

                        var cleanAllowed = fixGeometry(allowedZone);

                        if (cleanShape && cleanAllowed) {

                            var intersection = turf.intersect(cleanAllowed, cleanShape);

                            allowedZone = intersection ? intersection : null;

                        } else { allowedZone = null; }

                    }

                    if (!allowedZone) break;

                }

                L.geoJSON(worldPoly, { style: { color: 'none', fillColor: '#ff0000', fillOpacity: 0.15 } }).addTo(logicLayer);

                if (allowedZone) {

                    L.geoJSON(allowedZone, { style: { color: 'none', fillColor: '#00ff00', fillOpacity: 0.3 } }).addTo(logicLayer);

                }

            } catch (e) { console.error("Logic Engine Error:", e); }

        }



        // --- GEOLOCATION TOOLS ---

        function locateMe() {

            if (!navigator.geolocation) { alert("GPS not supported"); return; }

            var btn = document.querySelector('.gps-btn');

            btn.style.background = "#d4edda"; btn.innerText = "⏳";

           

            var options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };



            navigator.geolocation.getCurrentPosition(function(position) {

                var lat = position.coords.latitude; var lng = position.coords.longitude;

                gpsLayer.clearLayers(); map.setView([lat, lng], 15);

                L.marker([lat, lng]).addTo(gpsLayer).bindPopup("You are here").openPopup();

                L.circle([lat, lng], {radius: 40, color: '#0078A8', fillOpacity: 0.1, weight: 1, dashArray: '5,5'}).addTo(gpsLayer);

                btn.style.background = "#f0f0f0"; btn.innerText = "◎";

            }, function(error) {

                var msg = "GPS Error.";

                if (error.code === 1) msg = "Permission Denied. Please allow location access.";

                else if (error.code === 2) msg = "Position Unavailable. Check GPS signal.";

                else if (error.code === 3) msg = "Timeout getting location.";

               

                alert(msg + "\nNote: Mobile browsers require HTTPS for GPS.");

                btn.style.background = "#f8d7da"; btn.innerText = "❌";

            }, options);

        }



        function radiusAtGPS() {

            if (!navigator.geolocation) { alert("GPS not supported"); return; }

            var btn = document.getElementById('btnGpsRadius');

            var oldText = btn.innerText;

            btn.innerText = "Locating...";

           

            var options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };



            navigator.geolocation.getCurrentPosition(function(position) {

                drawRadiusAt(position.coords.latitude, position.coords.longitude);

                btn.innerText = oldText;

            }, function(error) {

                var msg = "GPS Error.";

                if (error.code === 1) msg = "Permission Denied.";

                alert("Could not place radius: " + msg);

                btn.innerText = oldText;

            }, options);

        }



        // --- POPUP WINDOW ---

        function openPopup(url) {

            window.open(url, "TransitInfo", "width=400,height=600,resizable=yes,scrollbars=yes,status=yes");

        }



        // --- TUTORIAL LOGIC ---

        function checkTutorial() {

            if (!localStorage.getItem('gm_tutorial_seen')) {

                document.getElementById('tutorialModal').style.display = 'block';

            }

        }

        function closeTutorial() {

            document.getElementById('tutorialModal').style.display = 'none';

            localStorage.setItem('gm_tutorial_seen', 'true');

        }

        function openTutorial() {

            document.getElementById('tutorialModal').style.display = 'block';

        }



        // --- CONSTRAINT MANAGEMENT ---

        function addConstraint(type, geoJsonShape, label, visualGeoJSON) {

            var id = Date.now();

            var layer = null;

            if (visualGeoJSON) {

                layer = L.geoJSON(visualGeoJSON, { style: { color: 'black', weight: 2, dashArray: '5, 5', fill: false } }).addTo(guideLayer);

            }

            myConstraints.push({ id: id, type: type, geometry: geoJsonShape, state: 'hit', name: label, leafletLayer: layer, visualGeometry: visualGeoJSON });

            saveConstraints(); updateLayerList(); updateLogicMap(); switchTab('layers');

        }



        function removeConstraint(id) {

            var idx = myConstraints.findIndex(c => c.id === id);

            if (idx > -1) {

                if (myConstraints[idx].leafletLayer) guideLayer.removeLayer(myConstraints[idx].leafletLayer);

                myConstraints.splice(idx, 1);

                saveConstraints(); updateLayerList(); updateLogicMap();

            }

        }



        function renameConstraint(id) {

            var c = myConstraints.find(c => c.id === id);

            if (c) {

                var newName = prompt("Rename:", c.name);

                if (newName && newName.trim() !== "") { c.name = newName.trim(); saveConstraints(); updateLayerList(); }

            }

        }



        function toggleConstraintState(id, newState) {

            var c = myConstraints.find(c => c.id === id);

            if (c) { c.state = newState; saveConstraints(); updateLayerList(); updateLogicMap(); }

        }



        function saveConstraints() {

            var toSave = myConstraints.map(c => ({ id: c.id, type: c.type, geometry: c.geometry, state: c.state, name: c.name, visualGeometry: c.visualGeometry }));

            localStorage.setItem('gm_constraints_v36', JSON.stringify(toSave));

        }



        function loadConstraints() {

            var saved = localStorage.getItem('gm_constraints_v36');

            if (saved) {

                try {

                    var data = JSON.parse(saved);

                    myConstraints = []; guideLayer.clearLayers();

                    data.forEach(c => {

                        var layer = null;

                        if (c.visualGeometry) { layer = L.geoJSON(c.visualGeometry, { style: { color: 'black', weight: 2, dashArray: '5, 5', fill: false } }).addTo(guideLayer); }

                        myConstraints.push({ id: c.id, type: c.type, geometry: c.geometry, state: c.state, name: c.name, visualGeometry: c.visualGeometry, leafletLayer: layer });

                    });

                    updateLayerList(); updateLogicMap();

                } catch(e) { console.error("Failed to load saved constraints", e); }

            }

        }



        function updateLayerList() {

            var list = document.getElementById('layerList'); list.innerHTML = "";

            myConstraints.slice().reverse().forEach(c => {

                var li = document.createElement('li'); li.className = 'layer-item';

                var controlsHtml = "";

                if (c.type === 'radius' || c.type === 'borough' || c.type === 'zone') {

                    controlsHtml = `<button class="toggle-btn ${c.state==='hit'?'is-hit':''}" onclick="toggleConstraintState(${c.id}, 'hit')">HIT</button><button class="toggle-btn ${c.state==='miss'?'is-miss':''}" onclick="toggleConstraintState(${c.id}, 'miss')">MISS</button>`;

                } else if (c.type === 'angle') {

                    controlsHtml = `<button class="toggle-btn ${c.state==='hit'?'is-hit':''}" onclick="toggleConstraintState(${c.id}, 'hit')">Side A</button><button class="toggle-btn ${c.state==='miss'?'is-miss':''}" onclick="toggleConstraintState(${c.id}, 'miss')">Side B</button>`;

                }

                li.innerHTML = `<div class="layer-header"><span class="layer-name" onclick="renameConstraint(${c.id})">${c.name}</span><div class="icon-group"><button class="icon-btn" onclick="renameConstraint(${c.id})">✎</button><button class="icon-btn del-btn" onclick="removeConstraint(${c.id})">×</button></div></div><div class="layer-controls">${controlsHtml}</div>`;

                list.appendChild(li);

            });

        }



        function toggleControls() {

            var c = document.getElementById('controls'); c.classList.toggle('minimized');

            var btn = document.getElementById('minBtn'); btn.innerText = c.classList.contains('minimized') ? "+" : "−";

        }



        function resetTools() {

            document.getElementById('btnRadius').classList.remove('active-tool-btn');

            document.getElementById('btnAngle').classList.remove('active-tool-btn');

            document.getElementById('map').classList.remove('crosshair-cursor');

            if(angleGhost) { map.removeLayer(angleGhost); angleGhost = null; }

            if(angleMoveHandler) { map.off('mousemove', angleMoveHandler); angleMoveHandler = null; }

        }



        function startRadiusTool(e) {

            e.stopPropagation(); resetTools();

            document.getElementById('btnRadius').classList.add('active-tool-btn');

            document.getElementById('map').classList.add('crosshair-cursor');

            var c = document.getElementById('controls'); if (!c.classList.contains('minimized')) toggleControls();

            map.once('click', function(ev) {

                drawRadiusAt(ev.latlng.lat, ev.latlng.lng); resetTools();

                if (document.getElementById('controls').classList.contains('minimized')) toggleControls();

            });

        }



        var angleGhost = null; var angleMoveHandler = null;

        function startAngleTool(e) {

            e.stopPropagation(); resetTools();

            document.getElementById('btnAngle').classList.add('active-tool-btn');

            document.getElementById('map').classList.add('crosshair-cursor');

            var c = document.getElementById('controls'); if (!c.classList.contains('minimized')) toggleControls();

            map.once('click', function(startEv) {

                var origin = startEv.latlng;

                angleGhost = L.polyline([origin, origin], {color:'black', dashArray:'5,5'}).addTo(map);

                angleMoveHandler = function(moveEv) { angleGhost.setLatLngs([origin, moveEv.latlng]); };

                map.on('mousemove', angleMoveHandler);

                map.once('click', function(endEv) {

                    var b = turf.rhumbBearing([origin.lng, origin.lat], [endEv.latlng.lng, endEv.latlng.lat]);

                    drawAngleAt(origin.lat, origin.lng, b); resetTools();

                    if (document.getElementById('controls').classList.contains('minimized')) toggleControls();

                });

            });

        }



        function undoLast() { if(myConstraints.length>0) removeConstraint(myConstraints[myConstraints.length-1].id); }

        function manualRadius() { var c=document.getElementById('radiusCoords').value.split(','); if(c.length===2) drawRadiusAt(parseFloat(c[0]), parseFloat(c[1])); }

        function manualAngle() { var c=document.getElementById('angleCoords').value.split(','); if(c.length===2) { var b=prompt("Bearing:", "90"); drawAngleAt(parseFloat(c[0]), parseFloat(c[1]), parseFloat(b)); }}



        function getSegmentPoints(start, end) {

            var dist = turf.rhumbDistance(start, end); var bearing = turf.rhumbBearing(start, end); var steps = 25; var points = [];

            for (var i = 0; i <= steps; i++) { var d = (dist * i) / steps; var pt = turf.rhumbDestination(start, d, bearing); points.push(pt.geometry.coordinates); }

            return points;

        }



        function drawAngleAt(lat, lng, bearing) {

            try {

                var sizeKm = 100; var origin = turf.point([lng, lat]);

                var pForw = turf.rhumbDestination(origin, sizeKm, bearing); var pBack = turf.rhumbDestination(origin, sizeKm, bearing + 180);

                var pForwLeft = turf.rhumbDestination(pForw, sizeKm, bearing - 90); var pBackLeft = turf.rhumbDestination(pBack, sizeKm, bearing - 90);

                var s1 = getSegmentPoints(origin, pForw); var s2 = getSegmentPoints(pForw, pForwLeft); var s3 = getSegmentPoints(pForwLeft, pBackLeft);

                var s4 = getSegmentPoints(pBackLeft, pBack); var s5 = getSegmentPoints(pBack, origin);

                var ring = [...s1, ...s2.slice(1), ...s3.slice(1), ...s4.slice(1), ...s5.slice(1)];

                var poly = turf.polygon([ring]); var guideLine = turf.lineString([pBack.geometry.coordinates, pForw.geometry.coordinates]);

                addConstraint('angle', poly, `Line ${Math.round(bearing)}°`, guideLine);

            } catch(e) { console.error("Geometry Gen Error", e); }

        }



        function drawRadiusAt(lat, lng) {

            var r = parseFloat(document.getElementById('radiusInput').value);

            var poly = turf.circle([lng, lat], r, {steps: 128, units: 'kilometers'});

            addConstraint('radius', poly, `Radius ${r}km`, poly);

        }



        function clearAll() { myConstraints = []; guideLayer.clearLayers(); saveConstraints(); updateLayerList(); updateLogicMap(); }



        function renderLog() {

            var list = document.getElementById('logList'); list.innerHTML = "";

            if (logEntries.length === 0) { list.innerHTML = "<div style='padding:10px; color:#999; font-style:italic;'>No tasks completed yet.</div>"; return; }

            logEntries.forEach((entryName, index) => {

                var div = document.createElement('div'); div.className = 'log-list-item';

                div.innerHTML = `<div style="display:flex; align-items:center;"><span class="log-index">${index + 1}.</span><span>${entryName}</span></div>`;

                list.appendChild(div);

            });

        }



        function clearLog() {

            if(confirm("Clear completion history?")) {

                logEntries = []; localStorage.removeItem('gm_question_log');

                questionState = {}; localStorage.removeItem('gm_question_state');

                renderLog(); renderQuestions();

            }

        }



        function switchTab(t) {

            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));

            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));

            document.getElementById('tab-'+t).classList.add('active');

        }



        const questionData = {

            "1. Matching - Draw 3 Pick 1": [

                { name: "Transit", items: ["Commercial Airport", "Transit Line", "Station's Name Length", "Street or Path"] },

                { name: "Administrative", items: ["1st", "2nd", "3rd", "4th"] },

                { name: "Natural", items: ["Mountain", "Landmass", "Park"] },

                { name: "POIs", items: ["Amusement Park", "Zoo", "Aquarium", "Golf Course", "Museum", "Cinema"] },

                { name: "Utilities", items: ["Hospital", "Library", "Consulate"] }

            ],

            "2. Measuring - Draw 3 Pick 1": [

                { name: "Transit", items: ["Commercial Airport", "Transit Line", "Station's name Length", "Street or Path"] },

                { name: "Administrative Division Borders", items: ["Country", "1st", "2nd"] },

                { name: "Natural", items: ["A Mountain", "A Landmass", "A Park", "Sea Level", "A Body of Water"] },

                { name: "POIs", items: ["An Amusement Park", "A Zoo", "An Aquarium", "A Golf Course", "A Museum", "A Cinema"] },

                { name: "Utilities", items: ["A Hospital", "A Library", "A Consulate"] }

            ],

            "3. Thermometer - Draw 2 Pick 1": [

                { name: "Distances", items: ["1km", "5km", "15km (Medium)", "75km (Large)"] }

            ],

            "4. Radar - Draw 2 Pick 1": [

                { name: "Ranges", items: ["500m", "1km", "2km", "5km", "10km", "15km", "40km", "80km", "160km", "Custom"] }

            ],

            "5. Tentacles - Draw 4 Pick 2": [

                { name: "Medium and Large - 2km", items: ["Museums", "Libraries", "Cinemas", "Hospitals"] },

                { name: "Large - 25km", items: ["Transit Lines", "Zoos", "Aquariums", "Amusement Parks"] }

            ],

            "6. Photos - Draw 1": [

                { name: "All Games", items: ["A Tree (entire)", "The Sky (Directly Up)", "You (Selfie, fully extended)", "Widest Street (Both Sides)", "Tallest Structure in Sightline", "Any Building Visible From Station"] },

                { name: "Medium and Large", items: ["Tallest Building From Station", "Trace Nearest Street/Path", "Two Buildings", "Restaurant Interior", "Train Platform", "Park", "S/Market Store Aisle", "Place of Worship"] },

                { name: "Large", items: ["Strava Map", "Tallest Mountain visible from station", "Biggest Body Of Water in Your Zone", "Five Buildings"] }

            ]

        };



        var questionState = JSON.parse(localStorage.getItem('gm_question_state')) || {};

        var openSections = JSON.parse(localStorage.getItem('gm_open_sections')) || {"1. Matching - Draw 3 Pick 1": true};

        var logEntries = JSON.parse(localStorage.getItem('gm_question_log')) || [];



        function renderQuestions() {

            var container = document.getElementById('questionsContainer'); container.innerHTML = "";

            Object.keys(questionData).forEach(catKey => {

                var catDiv = document.createElement('div'); catDiv.className = 'q-category';

                var header = document.createElement('div'); header.className = 'q-cat-title';

                header.innerHTML = `${catKey} <span class="arrow">${openSections[catKey] ? '▼' : '▶'}</span>`;

                header.onclick = function() { openSections[catKey] = !openSections[catKey]; localStorage.setItem('gm_open_sections', JSON.stringify(openSections)); renderQuestions(); };

                catDiv.appendChild(header);

                var contentDiv = document.createElement('div'); contentDiv.className = 'q-content ' + (openSections[catKey] ? "open" : "");

                questionData[catKey].forEach(sub => {

                    var subHeader = document.createElement('div'); subHeader.className = 'q-subcat'; subHeader.innerText = sub.name; contentDiv.appendChild(subHeader);

                    var grid = document.createElement('div'); grid.className = 'q-grid';

                    sub.items.forEach(item => {

                        var qKey = catKey + "_" + sub.name + "_" + item;

                        var btn = document.createElement('div'); btn.className = 'q-btn ' + (questionState[qKey] ? 'asked' : ''); btn.innerText = item;

                        btn.onclick = function() { toggleQuestion(qKey, item, sub.name, catKey, this); }; grid.appendChild(btn);

                    });

                    contentDiv.appendChild(grid);

                });

                catDiv.appendChild(contentDiv); container.appendChild(catDiv);

            });

        }



        function toggleQuestion(key, itemName, subName, catName, btnElement) {

            questionState[key] = !questionState[key]; localStorage.setItem('gm_question_state', JSON.stringify(questionState));

            var logText = `${itemName} <span class="log-meta">(${catName})</span>`;

            if (questionState[key]) { btnElement.classList.add('asked'); logEntries.push(logText); }

            else { btnElement.classList.remove('asked'); var idx = logEntries.indexOf(logText); if (idx > -1) logEntries.splice(idx, 1); }

            localStorage.setItem('gm_question_log', JSON.stringify(logEntries)); renderLog();

        }



        window.onload = function() { renderLog(); renderQuestions(); loadConstraints(); checkTutorial(); };



        // --- DATA DEFS ---

        const allowedStations=["Altrincham","Appley Bridge","Ardwick","Ashburys","Ashton-under-Lyne","Atherton","Belle Vue","Blackrod","Bolton","Bramhall","Bredbury","Brinnington","Broadbottom","Bromley Cross","Bryn","Burnage","Castleton","Chassen Road","Cheadle Hulme","Clifton","Daisy Hill","Davenport","Deansgate","Dinting","East Didsbury","Eccles","Fairfield","Farnworth","Flixton","Flowery Field","Gatley","Gathurst","Glazebrook","Glossop","Godley","Gorton","Greenfield","Guide Bridge","Hadfield","Hag Fold","Hale","Hall-i'-th'-Wood","Hattersley","Hazel Grove","Heald Green","Heaton Chapel","Hindley","Horwich Parkway","Humphrey Park","Hyde Central","Hyde North","Ince","Irlam","Kearsley","Levenshulme","Littleborough","Lostock","Manchester Airport","Manchester Oxford Road","Manchester Piccadilly","Manchester Victoria","Marple","Mauldeth Road","Middlewood","Mills Hill","Moorside","Moses Gate","Mossley","Moston","Navigation Road","Newton for Hyde","Orrell","Patricroft","Pemberton","Reddish North","Rochdale","Romiley","Rose Hill","Rose Hill Marple","Ryder Brow","Salford Central","Salford Crescent","Smithy Bridge","Stalybridge","Stockport","Strines","Swinton","Trafford Park","Urmston","Walkden","Westhoughton","Wigan North Western","Wigan Wallgate","Woodley","Woodsmoor"].map(s=>s.toLowerCase());

        const stationAliases = {"trafford palazzo":"barton dock road","robinswood road":"robinswood","rochdale town centre":"rochdale town centre","rochdale railway station":"rochdale railway station","deansgate-castlefield ( deansgate)":"deansgate-castlefield","oldham mumps":"oldham mumps","st peter's square":"st peter's square","st. peter's square":"st peter's square"};

        const tramLines = [{name:"Alty-Bury",color:"#00cc00",weight:4,stops:["Altrincham","Navigation Road","Timperley","Brooklands","Sale","Dane Road","Stretford","Old Trafford","Trafford Bar","Cornbrook","Deansgate-Castlefield","St Peter's Square","Market Street","Shudehill","Manchester Victoria","Queens Road","Abraham Moss","Crumpsall","Bowker Vale","Heaton Park","Prestwich","Besses o' th' Barn","Whitefield","Radcliffe","Bury"]},{name:"Alty-Picc",color:"purple",weight:3,stops:["Altrincham","Navigation Road","Timperley","Brooklands","Sale","Dane Road","Stretford","Old Trafford","Trafford Bar","Cornbrook","Deansgate-Castlefield","St Peter's Square","Piccadilly Gardens","Manchester Piccadilly"]},{name:"Ashton-Eccles",color:"#00BFFF",weight:3,stops:["Ashton-under-Lyne","Ashton West","Ashton Moss","Audenshaw","Droylsden","Cemetery Road","Edge Lane","Clayton Hall","Velopark","Etihad Campus","Holt Town","New Islington","Manchester Piccadilly","Piccadilly Gardens","St Peter's Square","Deansgate-Castlefield","Cornbrook","Pomona","Exchange Quay","Salford Quays","Anchorage","Harbour City","MediaCityUK","Broadway","Langworthy","Weaste","Ladywell","Eccles"]},{name:"Bury-Picc",color:"#00cc00",weight:3,stops:["Bury","Radcliffe","Whitefield","Besses o' th' Barn","Prestwich","Heaton Park","Bowker Vale","Crumpsall","Abraham Moss","Queens Road","Manchester Victoria","Shudehill","Market Street","Piccadilly Gardens","Manchester Piccadilly"]},{name:"Didsbury-Rochdale",color:"hotpink",weight:3,stops:["East Didsbury","Didsbury Village","West Didsbury","Burton Road","Withington","St Werburgh's Road","Chorlton","Firswood","Trafford Bar","Cornbrook","Deansgate-Castlefield","St Peter's Square","Exchange Square","Manchester Victoria","Monsall","Central Park","Newton Heath and Moston","Failsworth","Hollinwood","South Chadderton","Freehold","Westwood","Oldham King Street","Oldham Central","Oldham Mumps","Derker","Shaw and Crompton","Newhey","Milnrow","Kingsway Business Park","Newbold","Rochdale Railway Station","Rochdale Town Centre"]},{name:"Trafford-Deansgate",color:"red",weight:3,stops:["The Trafford Centre","Trafford Palazzo","Parkway","Village","Imperial War Museum","Wharfside","Pomona","Cornbrook","Deansgate-Castlefield"]},{name:"Airport-Vic",color:"navy",weight:3,stops:["Manchester Airport","Shadowmoss","Peel Hall","Robinswood Road","Wythenshawe Town Centre","Crossacres","Benchill","Martinscroft","Roundthorn","Baguley","Moor Road","Wythenshawe Park","Northern Moor","Sale Water Park","Barlow Moor Road","St Werburgh's Road","Chorlton","Firswood","Trafford Bar","Cornbrook","Deansgate-Castlefield","St Peter's Square","Market Street","Shudehill","Manchester Victoria"]}];

       

        async function loadTransportData() {

            var btn = document.getElementById('btnLoadTransport'); var loader = document.getElementById('loader');

            btn.disabled = true; loader.style.display = 'block';

            var savedData = localStorage.getItem('gm_transport_data');

            if (savedData) { processData(JSON.parse(savedData)); loader.style.display = 'none'; document.getElementById('legend').style.display = 'block'; return; }

           

            var bbox="53.30,-2.75,53.68,-1.90";

            var q=`[out:json][timeout:25];(node["railway"="tram_stop"](${bbox});node["railway"="station"](${bbox});way["railway"="rail"]["usage"="main"](${bbox});way["railway"="rail"]["usage"="branch"](${bbox}););out body;>;out skel qt;`;

            try {

                const r = await fetch("https://overpass-api.de/api/interpreter?data="+encodeURIComponent(q));

                const d = await r.json();

                try { localStorage.setItem('gm_transport_data', JSON.stringify(d)); } catch(e) {}

                processData(d); loader.style.display = 'none'; document.getElementById('legend').style.display = 'block';

            } catch(e) { alert("Data Load Error. Check connection."); btn.disabled = false; loader.style.display = 'none'; }

        }



        function forceRefreshData() { localStorage.removeItem('gm_transport_data'); document.getElementById('btnLoadTransport').disabled = false; loadTransportData(); }



        function processData(d){

            stationMap = {};

            var n={}; var sm={};

            d.elements.forEach(e=>{

                if(e.type==="node"){

                    n[e.id]=[e.lat,e.lon];

                    if(e.tags&&e.tags.name){

                        var rawName = e.tags.name.toLowerCase();

                        var cn = rawName.replace(" station","").replace(" rail station","").replace(" metrolink","").trim();

                        var searchKey = cn.replace(/\./g, "").replace(/\s+/g, " ");

                       

                        sm[cn]=[e.lat,e.lon]; stationMap[searchKey] = [e.lat, e.lon];



                        var isTram = e.tags.railway==="tram_stop";

                        var isRail = e.tags.railway==="station";

                        var crs = e.tags["ref:crs"] || e.tags["ref"] || null;



                        if(isTram){

                            // NEW CLEAN LOGIC: remove non-alphanumeric (dots, apostrophes), then dashify, then append -tram

                            var slug = cn.replace(/[^a-z0-9\s-]/g, "").replace(/\s+/g, "-") + "-tram";

                            var tramUrl = `https://tfgm.com/travel-updates/live-departures/tram/${slug}`;

                            L.circleMarker([e.lat,e.lon],{radius:4,fillColor:"#FFC107",color:"#333",weight:1,fillOpacity:1})

                             .addTo(transportLayer)

                             .bindPopup(`<b>${e.tags.name}</b><br><button class='popup-link' onclick='openPopup("${tramUrl}")'>Live Trams</button>`);

                        } else if(isRail){

                            if(allowedStations.some(s=>cn.includes(s))){

                                var trainLink = `https://www.realtimetrains.co.uk/search/detailed/gb-nr:${crs ? crs : e.tags.name}`;

                                L.circleMarker([e.lat,e.lon],{radius:5,fillColor:"#333",color:"#fff",weight:1.5,fillOpacity:1})

                                 .addTo(transportLayer)

                                 .bindPopup(`<b>${e.tags.name}</b><br><button class='popup-link' onclick='openPopup("${trainLink}")'>Realtime Trains</button>`);

                            }

                        }

                    }

                }

            });

            d.elements.forEach(e=>{ if(e.type==="way"&&e.tags.railway==="rail"){ var c=e.nodes.map(id=>n[id]).filter(x=>x); L.polyline(c,{color:'#444',weight:2,dashArray:'5,8',opacity:0.6}).addTo(transportLayer); }});

            tramLines.forEach(l=>{ var lc=[]; l.stops.forEach(rn=>{ var sn=rn.toLowerCase().trim(); if(stationAliases[sn])sn=stationAliases[sn]; var fc=sm[sn]; if(!fc){ var pm=Object.keys(sm).find(k=>k.includes(sn)||sn.includes(k)); if(pm)fc=sm[pm]; } if(fc)lc.push(fc); }); if(lc.length>1)L.polyline(lc,{color:l.color,weight:l.weight,opacity:0.6}).addTo(transportLayer); });

        }

        function toggleTransport(){if(map.hasLayer(transportLayer))map.removeLayer(transportLayer);else map.addLayer(transportLayer);}

    </script>

</body>

</html>